<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSC English - Error Spotting Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;600;700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, deleteDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
       // --- 1. QUESTION DATA ---
        import { questionLibrary } from './questions.js';
        
        // Safety check to ensure data loaded
        if (!questionLibrary || questionLibrary.length === 0) {
            console.error("Critical Error: 'questions.js' is empty or failed to load.");
            alert("Error: Questions could not be loaded. Please ensure 'questions.js' is in the same folder and you are running a local server.");
        } else {
            console.log("SUCCESS: Loaded " + questionLibrary.length + " questions from external file.");
        }


        // --- FIREBASE CONFIG (EXACTLY AS PROVIDED BY USER) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBsjdMiR5Sm22NHyCRUJnSgcziSFobxORw",
            authDomain: "paid-ai-test-series.firebaseapp.com",
            projectId: "paid-ai-test-series",
            storageBucket: "paid-ai-test-series.firebasestorage.app",
            messagingSenderId: "132297579024",
            appId: "1:132297579024:web:8e70b891ed4f709efec895"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ssc-english-v1';

        // --- STATE ---
        const state = {
            user: null,
            questions: [],
            currentTest: null,
            timerInterval: null,
            localDeviceId: localStorage.getItem('ssc_device_id') || crypto.randomUUID(),
            userStats: {
                weakTopics: [] 
            }
        };

        if (!localStorage.getItem('ssc_device_id')) localStorage.setItem('ssc_device_id', state.localDeviceId);

// --- CONFIG: SYLLABUS CHAPTERS ---
const SUBJECT_CHAPTERS = [
    { id: "spotting_error", name: "Spotting Error", icon: "fa-exclamation-circle", color: "text-red-500", bg: "bg-red-50" },
    { id: "sentence_improvement", name: "Sentence Improvement", icon: "fa-magic", color: "text-blue-500", bg: "bg-blue-50" },
    { id: "fill_blanks", name: "Fill in the blanks", icon: "fa-pencil-alt", color: "text-green-500", bg: "bg-green-50" },
    { id: "voice_change", name: "Voice Change", icon: "fa-bullhorn", color: "text-orange-500", bg: "bg-orange-50" },
    { id: "direct_indirect", name: "Direct & Indirect", icon: "fa-quote-right", color: "text-teal-500", bg: "bg-teal-50" },
    { id: "synonyms", name: "Synonyms", icon: "fa-copy", color: "text-indigo-500", bg: "bg-indigo-50" },
    { id: "antonyms", name: "Antonyms", icon: "fa-random", color: "text-pink-500", bg: "bg-pink-50" },
    { id: "ows", name: "OWS", icon: "fa-font", color: "text-purple-500", bg: "bg-purple-50" },
    { id: "idioms", name: "Idioms", icon: "fa-lightbulb", color: "text-yellow-500", bg: "bg-yellow-50" },
    { id: "spelling", name: "Spelling", icon: "fa-spell-check", color: "text-cyan-500", bg: "bg-cyan-50" },
    { id: "reading_comp", name: "Reading Comp", icon: "fa-book-open", color: "text-gray-600", bg: "bg-gray-100" },
    { id: "cloze_test", name: "Cloze Tests", icon: "fa-puzzle-piece", color: "text-emerald-600", bg: "bg-emerald-50" },
    { id: "para_jumble", name: "Para Jumble", icon: "fa-align-justify", color: "text-rose-500", bg: "bg-rose-50" },
    { id: "mixed", name: "Mixed Bag", icon: "fa-layer-group", color: "text-white", bg: "bg-gradient-to-r from-blue-600 to-indigo-600" }
];

        // --- DOM & NAVIGATION ---
        const views = {
            login: document.getElementById('view-login'),
            dashboard: document.getElementById('view-dashboard'),
            test: document.getElementById('view-test'),
            analysis: document.getElementById('view-analysis'),
            profile: document.getElementById('view-profile'),
            locked: document.getElementById('view-locked'),
            expired: document.getElementById('view-expired'),
            adminDashboard: document.getElementById('view-admin-dashboard'),
            adminUsers: document.getElementById('view-admin-users')
        };

        function navigate(viewName) {
            console.log("Navigating to:", viewName);
            Object.values(views).forEach(el => el && el.classList.add('hidden'));
            
            const target = document.getElementById(`view-${viewName}`);
            if (target) {
                target.classList.remove('hidden');
                target.classList.add('fade-in');
            }
            
            // Trigger View Specific Logic
            if (viewName === 'dashboard') loadDashboard();
            if (viewName === 'admin-dashboard') loadAdminDashboard();
            if (viewName === 'admin-users') loadAdminUsers();
        }

        // --- LOGIC: AUTHENTICATION ---
        async function handleLogin(e) {
            e.preventDefault();
            const usernameInput = document.getElementById('login-username').value.trim();
            const passwordInput = document.getElementById('login-password').value.trim();
            const errorMsg = document.getElementById('login-error');
            errorMsg.classList.add('hidden');
            errorMsg.innerText = "";

            // Hardcoded Admin Access (Works without DB if needed for UI test)
            if (usernameInput === 'admin' && passwordInput === 'admin123') {
                state.user = { username: 'admin', name: 'Super Admin', role: 'admin' };
                navigate('admin-dashboard');
                return;
            }

            try {
                // Ensure we are authenticated (Anonymous or otherwise)
                if (!auth.currentUser) {
                     try {
                        await signInAnonymously(auth);
                     } catch(authErr) {
                         console.error("Auth Failed:", authErr);
                         let customMsg = "Database Connection Failed.";
                         
                         // Check for specific "Configuration Not Found" error
                         if(authErr.message && authErr.message.includes("configuration-not-found")) {
                             customMsg = "SETUP ERROR: 'Anonymous Auth' is not enabled in Firebase Console. Please enable it.";
                         } else if (authErr.message && authErr.message.includes("offline")) {
                             customMsg = "Connection Error: You seem to be offline.";
                         }

                         throw new Error(customMsg);
                     }
                }

                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'app_users', usernameInput);
                const userSnap = await getDoc(userRef);

                if (!userSnap.exists()) throw new Error("User ID not found.");
                const userData = userSnap.data();

                if (userData.password !== passwordInput) throw new Error("Incorrect password.");
                
                const today = new Date();
                if (new Date(userData.validUntil) < today) {
                    navigate('expired');
                    return;
                }

                // Device Lock Logic
                if (userData.role === 'student') {
                    if (userData.deviceId && userData.deviceId !== state.localDeviceId) {
                        navigate('locked');
                        return;
                    }
                    if (!userData.deviceId) {
                        await updateDoc(userRef, { deviceId: state.localDeviceId });
                        userData.deviceId = state.localDeviceId;
                    }
                }

                state.user = { ...userData, username: usernameInput };
                navigate('dashboard');
            } catch (err) {
                console.error(err);
                errorMsg.innerText = err.message || "Login failed.";
                errorMsg.classList.remove('hidden');
            }
        }

        // --- LOGIC: ADAPTIVE TEST GENERATION ---
        // --- UPDATED: Question Selection Logic (Dynamic Counts) ---
function getAdaptiveQuestions(targetChapter) {
    if (!questionLibrary || questionLibrary.length === 0) {
        alert("Critical Error: No questions loaded.");
        return [];
    }

    // 1. FILTER POOL
    let pool = [];
    if (targetChapter === "Mixed Bag") {
        pool = questionLibrary; // Use all questions
    } else {
        // Filter by Chapter
        pool = questionLibrary.filter(q => q.chapter === targetChapter);
    }

    if (pool.length === 0) {
        alert(`No questions found for topic: "${targetChapter}".\n\nPlease update questions.js with 'chapter' fields matching the buttons.`);
        return [];
    }

    // 2. DEFINE CONFIGURATION (Counts)
    let totalNeeded, cEasy, cMod, cHard;
    
    if (targetChapter === "Mixed Bag") {
        totalNeeded = 25;
        cEasy = 7;
        cMod = 8;
        cHard = 10;
    } else {
        totalNeeded = 10;
        cEasy = 3;
        cMod = 3;
        cHard = 4;
    }

    // 3. SEPARATE BY DIFFICULTY
    const easyQ = pool.filter(q => q.difficulty === 'easy');
    const modQ = pool.filter(q => q.difficulty === 'moderate');
    const hardQ = pool.filter(q => q.difficulty === 'hard');

    const select = (arr, count) => arr.sort(() => 0.5 - Math.random()).slice(0, count);

    // 4. BUILD SET
    let finalSet = [
        ...select(easyQ, cEasy),
        ...select(modQ, cMod),
        ...select(hardQ, cHard)
    ];

    // 5. FILL GAPS (If specific difficulties aren't available)
    if (finalSet.length < totalNeeded) {
        const usedIds = finalSet.map(q => q.id);
        const remaining = pool.filter(q => !usedIds.includes(q.id));
        finalSet = [...finalSet, ...select(remaining, totalNeeded - finalSet.length)];
    }

    return finalSet.sort(() => 0.5 - Math.random());
}

        // --- UPDATED: Start Test with Dynamic Timer ---
async function startTest(topic = "Mixed Bag") {
    // UI Feedback
    const grid = document.getElementById('chapter-grid');
    if(grid) grid.classList.add('opacity-50', 'pointer-events-none');

    setTimeout(() => {
        const testSet = getAdaptiveQuestions(topic);
        
        if (testSet.length === 0) {
            if(grid) grid.classList.remove('opacity-50', 'pointer-events-none');
            return;
        }

        // --- NEW: DYNAMIC TIME SETTING ---
        // Mixed Bag = 15 mins, Others = 5 mins
        const durationMinutes = (topic === "Mixed Bag") ? 15 : 5;

        state.questions = testSet;
        state.currentTest = {
            answers: {},
            startTime: new Date(),
            timeLeft: durationMinutes * 60, // Convert to seconds
            topicName: topic
        };

        renderTest();
        navigate('test');
        startTimer();
        
        if(grid) grid.classList.remove('opacity-50', 'pointer-events-none');
    }, 500); 
}

        function renderTest() {
            const container = document.getElementById('test-questions-container');
            container.innerHTML = '';
            state.questions.forEach((q, index) => {
                let diffBadge = '';
                if(q.difficulty === 'easy') diffBadge = 'bg-green-100 text-green-800';
                else if(q.difficulty === 'moderate') diffBadge = 'bg-yellow-100 text-yellow-800';
                else diffBadge = 'bg-red-100 text-red-800';

                const qEl = document.createElement('div');
                qEl.className = 'mb-8 p-5 bg-white rounded-xl shadow-sm border border-gray-100';
                qEl.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex space-x-2">
                            <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2.5 py-1 rounded">Q${index + 1}</span>
                            <span class="${diffBadge} text-xs font-bold px-2.5 py-1 rounded capitalize">${q.difficulty}</span>
                            <span class="bg-gray-100 text-gray-600 text-xs font-semibold px-2.5 py-1 rounded truncate max-w-[100px]">${q.topic}</span>
                        </div>
                    </div>
                    <p class="text-gray-800 font-medium mb-5 text-lg leading-relaxed font-serif">${q.question}</p>
                    <div class="space-y-3">
                        ${q.options.map((opt, i) => `
                            <label class="flex items-center p-3 border-2 border-transparent bg-gray-50 rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-200 transition-all option-label-${index}" onclick="selectAnswer('${q.id}', ${i}, ${index})">
                                <div class="w-5 h-5 flex items-center justify-center border-2 border-gray-300 rounded-full mr-3 text-blue-600 bg-white">
                                    <div class="w-2.5 h-2.5 rounded-full bg-current opacity-0 transition-opacity check-dot"></div>
                                </div>
                                <span class="text-gray-700">${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
                container.appendChild(qEl);
            });
        }

        window.selectAnswer = (qId, optionIndex, uiIndex) => {
            state.currentTest.answers[qId] = optionIndex;
            // Visual Update
            const labels = document.querySelectorAll(`.option-label-${uiIndex}`);
            labels.forEach(l => {
                l.classList.remove('bg-blue-100', 'border-blue-500', 'ring-1', 'ring-blue-500');
                l.querySelector('.check-dot').classList.add('opacity-0');
            });
            const selected = labels[optionIndex];
            selected.classList.add('bg-blue-100', 'border-blue-500');
            selected.querySelector('.check-dot').classList.remove('opacity-0');
        };

        function startTimer() {
            const timerEl = document.getElementById('test-timer');
            state.timerInterval = setInterval(() => {
                state.currentTest.timeLeft--;
                const m = Math.floor(state.currentTest.timeLeft / 60);
                const s = state.currentTest.timeLeft % 60;
                timerEl.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                if (state.currentTest.timeLeft <= 0) submitTest();
            }, 1000);
        }

        async function submitTest() {
            clearInterval(state.timerInterval);

            // --- 1. CALCULATE SCORE & TOPIC STATS ---
            let score = 0;
            let attempted = 0;
            const topicStats = {}; // { "Nouns": { total: 2, correct: 1 } }

            const details = state.questions.map(q => {
                const userAnswer = state.currentTest.answers[q.id];
                const isCorrect = userAnswer === q.correctIndex;
                const topicName = q.topic || "General"; // Use specific topic (e.g., "Nouns") not just Chapter

                // Init stats if new
                if (!topicStats[topicName]) topicStats[topicName] = { total: 0, correct: 0 };
                
                if (userAnswer !== undefined) {
                    attempted++;
                    topicStats[topicName].total++; // Count attempt
                    if (isCorrect) {
                        score++;
                        topicStats[topicName].correct++;
                    }
                }
                return { ...q, userAnswer, isCorrect };
            });

            // --- 2. SAVE PROGRESS & STATS TO DB ---
            try {
                const todayStr = new Date().toISOString().split('T')[0];
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'app_users', state.user.username);
                
                // Get current user stats first to merge
                // Note: In a real app, you might fetch this first or use a deep merge. 
                // Here we assume state.user has the latest or we just update what we have.
                // Better approach: Use Firestore transaction or merge.
                // For simplicity: We will fetch the latest stats map, update it, and save back.
                
                const userSnap = await getDoc(userRef);
                const userData = userSnap.data();
                
                let currentStats = userData.topicPerformance || {};
                let currentCount = (userData.lastActiveDate === todayStr) ? (userData.questionsToday || 0) : 0;

                // Merge new stats
                for (const [t, data] of Object.entries(topicStats)) {
                    if (!currentStats[t]) currentStats[t] = { total: 0, correct: 0 };
                    currentStats[t].total += data.total;
                    currentStats[t].correct += data.correct;
                }

                // Update DB
                await updateDoc(userRef, {
                    questionsToday: currentCount + attempted, // Only count attempted ones for daily goal? Or total questions in test? Usually total in test.
                    // Let's stick to total questions in test as per previous logic
                    questionsToday: currentCount + state.questions.length, 
                    lastActiveDate: todayStr,
                    topicPerformance: currentStats
                });

                // Update Local State for UI
                state.user.topicPerformance = currentStats;
                state.user.questionsToday = currentCount + state.questions.length;
                state.user.lastActiveDate = todayStr;

            } catch (e) { console.error("Save failed", e); }

            // --- 3. RENDER ANALYSIS UI ---
            document.getElementById('score-display').innerText = `${score} / ${state.questions.length}`;
            document.getElementById('accuracy-display').innerText = attempted > 0 ? `${Math.round((score/attempted)*100)}%` : '0%';
            
            document.getElementById('analysis-list').innerHTML = details.map((d, i) => `
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 ${d.isCorrect ? 'border-green-500' : 'border-red-500'} mb-4">
                     <div class="flex justify-between mb-2">
                         <span class="text-xs font-bold text-gray-400 uppercase">${d.chapter} â€¢ ${d.topic}</span>
                         <span class="text-xs px-2 py-0.5 rounded bg-gray-100">${d.difficulty}</span>
                     </div>
                     <p class="font-bold text-gray-800 text-lg mb-3">Q${i+1}: ${d.question}</p>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                         <div class="p-2 rounded ${d.isCorrect ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'} font-bold text-sm">
                             Your Answer: ${d.userAnswer !== undefined ? d.options[d.userAnswer] : 'Skipped'}
                         </div>
                         <div class="p-2 rounded bg-gray-50 text-gray-700 font-bold text-sm">
                             Correct: ${d.options[d.correctIndex]}
                         </div>
                     </div>
                     <div class="bg-blue-50 p-3 rounded text-sm text-gray-700">
                         <p class="mb-1"><strong>ðŸ‡¬ðŸ‡§ English:</strong> ${d.explanation}</p>
                         <p><strong>ðŸ‡§ðŸ‡© Bengali:</strong> <span class="font-bengali">${d.explanationBengali}</span></p>
                     </div>
                </div>
            `).join('');

            navigate('analysis');
        }

        // --- ADMIN FUNCTIONS ---
        
        // This function was missing in previous version causing the Admin Panel to break
        async function loadAdminDashboard() {
            try {
                // Fetch stats
                const usersSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'app_users'));
                const totalUsers = usersSnap.size;
                
                let activeDevices = 0;
                let expiredUsers = 0;
                const today = new Date();

                usersSnap.forEach(doc => {
                    const u = doc.data();
                    if(u.deviceId) activeDevices++;
                    if(new Date(u.validUntil) < today) expiredUsers++;
                });

                document.getElementById('stat-total-users').innerText = totalUsers;
                document.getElementById('stat-active-devices').innerText = activeDevices;
                document.getElementById('stat-expired-users').innerText = expiredUsers;
            } catch (err) {
                console.error("Admin stats error:", err);
            }
        }

        async function loadAdminUsers() {
            const list = document.getElementById('user-list-body');
            list.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Loading users...</td></tr>';
            try {
                const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'app_users'));
                let html = '';
                if (snap.empty) {
                    html = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No users found. Create one above.</td></tr>';
                } else {
                    snap.forEach(d => {
                        const u = d.data();
                        const isExpired = new Date(u.validUntil) < new Date();
                        html += `
                            <tr class="border-b text-sm hover:bg-gray-50 transition">
                                <td class="p-3 font-medium text-gray-800">${u.name}</td>
                                <td class="p-3 text-blue-600 font-mono">${d.id}</td>
                                <td class="p-3 font-mono text-gray-500">${u.password}</td>
                                <td class="p-3">
                                    ${u.deviceId 
                                        ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800"><i class="fas fa-lock mr-1"></i> Locked</span>' 
                                        : '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Open</span>'}
                                    ${isExpired ? '<span class="ml-1 px-2 py-0.5 rounded text-xs bg-gray-200 text-gray-600">Expired</span>' : ''}
                                </td>
                                <td class="p-3 flex space-x-2 justify-end">
    <!-- Change Password Button -->
    <button onclick="changePassword('${d.id}')" title="Change Password" class="text-gray-600 hover:text-blue-600 border border-gray-200 px-2 py-1 rounded hover:bg-gray-50">
        <i class="fas fa-key"></i>
    </button>

    <!-- Reset Device Button -->
    <button onclick="resetDevice('${d.id}')" class="text-indigo-600 hover:text-indigo-900 font-medium text-xs border border-indigo-200 px-2 py-1 rounded hover:bg-indigo-50">
        Reset Device
    </button>
</td>
                            </tr>`;
                    });
                }
                list.innerHTML = html;
            } catch(err) {
                console.error(err);
                list.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500">Error loading data.</td></tr>';
            }
        }

        async function createUser(e) {
            e.preventDefault();
            const form = e.target;
            const btn = form.querySelector('button');
            const originalBtnText = btn.innerText;
            btn.innerText = "Creating...";
            btn.disabled = true;

            const phone = form.phone.value.trim();
            const name = form.name.value.trim();
            const days = parseInt(form.validity.value);

            if(!phone || !name) {
                alert("Please fill all fields");
                btn.innerText = originalBtnText;
                btn.disabled = false;
                return;
            }

            const validUntil = new Date();
            validUntil.setDate(validUntil.getDate() + days);
            
            // Generate simple password
            const password = Math.random().toString(36).slice(-6).toUpperCase();
            
            const userData = {
                name: name,
                password: password,
                role: 'student',
                validUntil: validUntil.toISOString().split('T')[0],
                deviceId: null,
                createdAt: new Date().toISOString()
            };
            
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'app_users', phone), userData);
                alert(`âœ… SUCCESS\n\nUser: ${name}\nID: ${phone}\nPassword: ${password}`);
                form.reset();
                loadAdminUsers();
                loadAdminDashboard(); // Refresh stats
            } catch(err) {
                console.error(err);
                alert("Error creating user: " + err.message);
            } finally {
                btn.innerText = originalBtnText;
                btn.disabled = false;
            }
        }

// --- NEW FUNCTION: Change User Password ---
window.changePassword = async (uid) => {
    const newPass = prompt(`Enter new password for user (${uid}):`);
    
    // Check if user actually entered something
    if (newPass !== null && newPass.trim() !== "") {
        try {
            // Update Firestore
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'app_users', uid), { 
                password: newPass.trim() 
            });
            alert("âœ… Password updated successfully!");
            loadAdminUsers(); // Refresh the table to show changes (optional, but good practice)
        } catch (err) {
            console.error(err);
            alert("Error updating password: " + err.message);
        }
    }
};

        window.resetDevice = async (uid) => {
            if(confirm(`Are you sure you want to reset the device lock for User ID: ${uid}?`)) {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'app_users', uid), { deviceId: null });
                    loadAdminUsers(); // Refresh table
                    loadAdminDashboard(); // Refresh stats
                    alert("Device reset successfully.");
                } catch(err) {
                    alert("Error resetting device: " + err.message);
                }
            }
        };

        function logout() {
            state.user = null;
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            navigate('login');
        }

        // Expose functions
        window.logout = logout;
        window.startTest = startTest;
        window.submitTest = submitTest;
        window.navigate = navigate;
        window.loadAdminUsers = loadAdminUsers;

        async function init() {
            try { 
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                   // Custom token auth if needed
                } else {
                    await signInAnonymously(auth); 
                }
            } catch(e) { console.error("Auth Error", e); }
            
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('create-user-form').addEventListener('submit', createUser);
            
            navigate('login');
        }

        init();
        
        // --- CORRECTED DASHBOARD LOADER (Merged) ---
async function loadDashboard() {
            if (state.user) {
                // 1. Name & Validity
                document.getElementById('student-name').innerText = state.user.name;
                const diff = Math.ceil((new Date(state.user.validUntil) - new Date()) / (1000 * 3600 * 24));
                const daysEl = document.getElementById('days-left');
                if(daysEl) {
                    daysEl.innerText = `${diff} Days Left`;
                    daysEl.className = diff <= 5 ? "ml-1 font-bold text-red-300" : "ml-1 font-bold text-green-300";
                }

                // 2. Daily Goal Logic
                const todayStr = new Date().toISOString().split('T')[0];
                let todayCount = 0;
                if (state.user.lastActiveDate === todayStr) {
                    todayCount = state.user.questionsToday || 0;
                }
                const progressText = document.getElementById('daily-progress-text');
                if(progressText) progressText.innerText = todayCount;
                const progressBar = document.getElementById('daily-progress-bar');
                if(progressBar) {
                    const pct = Math.min((todayCount / 50) * 100, 100);
                    progressBar.style.width = `${pct}%`;
                }

                // 3. WEAKNESS ANALYSIS (Top 10 Weakest Topics)
                const stats = state.user.topicPerformance || {};
                // Convert object to array: [{topic: "Nouns", accuracy: 45}, ...]
                const topicList = Object.keys(stats).map(topic => {
                    const data = stats[topic];
                    const acc = data.total > 0 ? (data.correct / data.total) * 100 : 0;
                    return { topic, accuracy: acc, total: data.total };
                });

                // Filter topics with at least 3 attempts to be significant
                // Sort by accuracy ascending (lowest first)
                const weakList = topicList
                    .filter(t => t.total >= 1) // Show even with 1 attempt for now to populate list
                    .sort((a, b) => a.accuracy - b.accuracy)
                    .slice(0, 10);

                const weaknessContainer = document.getElementById('weakness-list');
                if (weaknessContainer) {
                    if (weakList.length === 0) {
                        weaknessContainer.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">Practice more questions to see your weak areas.</p>';
                    } else {
                        weaknessContainer.innerHTML = weakList.map(w => `
                            <div class="flex justify-between items-center bg-red-50 p-2 rounded border border-red-100">
                                <span class="text-xs font-bold text-gray-700">${w.topic}</span>
                                <span class="text-xs font-bold text-red-600">${Math.round(w.accuracy)}%</span>
                            </div>
                        `).join('');
                    }
                }
            }

            // 4. Render Chapter Grid
            const grid = document.getElementById('chapter-grid');
            if (grid && typeof SUBJECT_CHAPTERS !== 'undefined') {
                grid.innerHTML = SUBJECT_CHAPTERS.map(ch => `
                    <button onclick="startTest('${ch.name}')" class="${ch.bg} p-3 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition flex flex-col items-center justify-center text-center h-24 relative overflow-hidden group">
                        <div class="w-8 h-8 rounded-full bg-white/80 flex items-center justify-center mb-2 shadow-sm group-hover:scale-110 transition">
                            <i class="fas ${ch.icon} ${ch.color} text-sm"></i>
                        </div>
                        <span class="text-[11px] font-bold ${ch.id === 'mixed' ? 'text-white' : 'text-gray-700'} leading-tight px-1">${ch.name}</span>
                    </button>
                `).join('');
            }
        }
    </script>

    <style>
        body { font-family: 'Poppins', 'Noto Sans Bengali', sans-serif; background-color: #f3f4f6; }
        .font-bengali { font-family: 'Noto Sans Bengali', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-gray-800 h-screen overflow-hidden flex flex-col font-sans">

    <!-- HEADER -->
    <header class="bg-indigo-900 text-white shadow-lg z-50 shrink-0">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-indigo-900 font-bold border-2 border-yellow-400 shadow-md">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div>
                    <h1 class="font-bold text-sm leading-tight tracking-wide">SSC INSIGHT BENGALI</h1>
                    <p class="text-[10px] text-indigo-200">Error Spotting Specialist</p>
                </div>
            </div>
            <button onclick="logout()" class="text-indigo-200 hover:text-white text-sm transition"><i class="fas fa-sign-out-alt fa-lg"></i></button>
        </div>
    </header>

    <!-- MAIN CONTAINER -->
    <main class="flex-grow overflow-y-auto relative max-w-md mx-auto w-full bg-gray-50 shadow-2xl">

        <!-- VIEW: LOGIN -->
        <div id="view-login" class="h-full flex flex-col justify-center px-8 bg-gradient-to-br from-indigo-900 via-blue-900 to-indigo-800 text-white">
            <div class="text-center mb-10">
                <div class="w-24 h-24 bg-white/10 backdrop-blur-md rounded-full flex items-center justify-center mx-auto mb-6 border border-white/20 shadow-xl">
                    <i class="fas fa-book-reader text-4xl text-yellow-400"></i>
                </div>
                <h2 class="text-3xl font-bold mb-1">Student Portal</h2>
                <p class="text-indigo-200 text-sm">SSC English Error Spotting</p>
            </div>
            
            <form id="login-form" class="space-y-5">
                <div>
                    <label class="block text-xs uppercase text-indigo-300 font-bold mb-1 ml-1">Mobile Number</label>
                    <div class="relative">
                        <span class="absolute left-4 top-3.5 text-indigo-300"><i class="fas fa-phone-alt"></i></span>
                        <input type="text" id="login-username" class="w-full pl-10 pr-4 py-3 rounded-xl bg-white/10 border border-indigo-400/30 text-white placeholder-indigo-400 focus:outline-none focus:border-yellow-400 focus:ring-1 focus:ring-yellow-400 transition shadow-inner" placeholder="Enter ID" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs uppercase text-indigo-300 font-bold mb-1 ml-1">Password</label>
                    <div class="relative">
                        <span class="absolute left-4 top-3.5 text-indigo-300"><i class="fas fa-key"></i></span>
                        <input type="password" id="login-password" class="w-full pl-10 pr-4 py-3 rounded-xl bg-white/10 border border-indigo-400/30 text-white placeholder-indigo-400 focus:outline-none focus:border-yellow-400 focus:ring-1 focus:ring-yellow-400 transition shadow-inner" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" required>
                    </div>
                </div>
                
                <div id="login-error" class="hidden text-red-200 bg-red-900/40 p-3 rounded-lg text-sm text-center border border-red-500/30"></div>

                <button type="submit" class="w-full py-4 bg-yellow-400 text-indigo-900 font-bold rounded-xl shadow-lg hover:bg-yellow-300 transform transition active:scale-95">
                    Start Learning <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </form>

            <div class="mt-10 text-center text-xs text-indigo-300 opacity-80">
                <p class="flex items-center justify-center"><i class="fas fa-shield-alt mr-2"></i> Secure Device Lock Active</p>
            </div>
        </div>

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="hidden p-5 space-y-6 min-h-full">
            <!-- ID Card -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl p-6 text-white shadow-xl relative overflow-hidden">
                <div class="absolute -right-6 -top-6 text-white/10 text-9xl"><i class="fas fa-id-card"></i></div>
                <div class="relative z-10">
                    <p class="text-sm text-indigo-100">Welcome back,</p>
                    <h2 class="text-2xl font-bold truncate mb-3" id="student-name">Student</h2>
                    <div class="inline-flex items-center bg-white/20 px-3 py-1.5 rounded-lg text-xs backdrop-blur-sm border border-white/10">
                        <i class="fas fa-hourglass-half mr-2 text-yellow-300"></i> Validity: <span id="days-left" class="ml-1 font-bold">-- Days</span>
                    </div>
                </div>
            </div>

            <!-- Action Card -->
           <!-- NEW: Daily Goal Tracker (No Start Button) -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6">
                <div class="p-5">
                    <div class="flex justify-between items-center mb-3">
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Daily Goal</h3>
                            <p class="text-xs text-gray-500">Practice any topic to reach target</p>
                        </div>
                        <div class="text-right">
                             <span id="daily-progress-text" class="text-2xl font-bold text-blue-600">0</span>
                             <span class="text-sm text-gray-400 font-semibold">/ 50</span>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-100 rounded-full h-3 mb-1">
                         <div id="daily-progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-1000 relative" style="width: 0%">
                             <div class="absolute right-0 top-0 bottom-0 w-1 bg-white/30 animate-pulse"></div>
                         </div>
                    </div>
                    <p class="text-[10px] text-gray-400 text-right">Questions Practiced Today</p>
                </div>
            </div>
<!-- WEAK AREAS CARD -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6 p-4">
                <h3 class="font-bold text-gray-800 text-sm mb-3 flex items-center">
                    <i class="fas fa-exclamation-triangle text-orange-500 mr-2"></i> Weakest Areas
                </h3>
                <div id="weakness-list" class="space-y-2">
                    <!-- JS will inject list here -->
                    <p class="text-xs text-gray-400 text-center py-2">Loading analysis...</p>
                </div>
            </div>
            <!-- NEW: Chapter Grid -->
            <div class="mt-2">
                <div class="flex justify-between items-end mb-3 px-1">
                    <h3 class="font-bold text-gray-800">Select Topic</h3>
                    <span class="text-[10px] text-gray-400 uppercase tracking-wider font-bold">14 Options</span>
                </div>
                
                <div id="chapter-grid" class="grid grid-cols-2 gap-3 pb-24">
                    <!-- JS will inject buttons here -->
                </div>
            </div>
                
            </div>


            <!-- Profile Button -->
            <button onclick="navigate('profile')" class="w-full py-4 bg-white border border-gray-200 text-gray-600 rounded-xl font-medium hover:bg-gray-50 transition shadow-sm flex items-center justify-center">
                <i class="fas fa-user-circle mr-2 text-xl"></i> View Profile
            </button>
        </div>

        <!-- VIEW: TEST -->
        <div id="view-test" class="hidden h-full flex flex-col bg-white">
            <div class="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-20 shadow-sm">
                <div class="flex items-center text-red-600 bg-red-50 px-3 py-1.5 rounded-lg border border-red-100">
                    <i class="fas fa-stopwatch mr-2 animate-pulse"></i>
                    <span id="test-timer" class="font-mono font-bold text-lg">20:00</span>
                </div>
                <button onclick="submitTest()" class="bg-green-600 text-white px-5 py-2 rounded-lg text-sm font-bold shadow hover:bg-green-700 transition">
                    Submit Test
                </button>
            </div>
            <div id="test-questions-container" class="flex-grow overflow-y-auto p-4 select-none bg-gray-50" oncontextmenu="return false;">
                <!-- Questions injected here -->
            </div>
        </div>

        <!-- VIEW: ANALYSIS -->
        <div id="view-analysis" class="hidden h-full flex flex-col bg-gray-50">
            <div class="p-8 bg-indigo-900 text-white text-center rounded-b-[2rem] shadow-xl shrink-0">
                <h2 class="text-indigo-200 text-sm font-bold uppercase tracking-widest mb-2">Test Complete</h2>
                <div class="text-6xl font-bold mb-2 text-yellow-400 tracking-tight" id="score-display">--</div>
                <div class="inline-block bg-white/10 backdrop-blur px-4 py-1 rounded-full text-sm font-medium border border-white/20" id="accuracy-display">--% Accuracy</div>
            </div>
            <div class="flex-grow overflow-y-auto p-4 pb-32 -mt-4">
                <div id="analysis-list" class="space-y-4 pb-8"></div>
                <button onclick="navigate('dashboard')" class="w-full py-4 mt-4 bg-gray-800 text-white rounded-xl font-bold shadow-lg hover:bg-gray-700 transition">
                    Back to Dashboard
                </button>
            </div>
        </div>

        <!-- VIEW: LOCKED -->
        <div id="view-locked" class="hidden h-full flex flex-col items-center justify-center p-8 bg-gray-100 text-center">
            <div class="w-20 h-20 bg-red-100 text-red-500 rounded-full flex items-center justify-center text-3xl mb-6 shadow-inner">
                <i class="fas fa-lock"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800">Device Locked</h2>
            <p class="text-gray-600 text-sm mt-3 leading-relaxed">
                Your account is bound to another device.<br>
                For security, one account = one device.
            </p>
            <div class="mt-8 p-4 bg-white rounded-lg border border-gray-200 text-xs text-left w-full text-gray-500 shadow-sm">
                <strong>How to fix?</strong><br>
                Contact the Admin via WhatsApp to request a "Device Reset" if you have changed your phone.
            </div>
            <button onclick="logout()" class="mt-8 text-blue-600 font-bold hover:underline">Return to Login</button>
        </div>
        
        <!-- VIEW: EXPIRED -->
        <div id="view-expired" class="hidden h-full flex flex-col items-center justify-center p-8 text-center bg-gray-50">
             <i class="fas fa-calendar-times text-5xl text-gray-300 mb-4"></i>
             <h2 class="text-2xl font-bold text-gray-800">Subscription Expired</h2>
             <p class="text-gray-500 mt-2 text-sm">Please renew to continue practicing.</p>
             <button onclick="logout()" class="mt-8 px-6 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-white transition">Logout</button>
        </div>

        <!-- VIEW: PROFILE -->
        <div id="view-profile" class="hidden h-full p-6 bg-gray-50">
            <h2 class="text-2xl font-bold text-indigo-900 mb-6">Profile Details</h2>
            <div class="bg-white p-6 rounded-2xl shadow-sm space-y-6 border border-gray-100">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">Institute</label>
                    <p class="text-gray-800 font-semibold mt-1">SSC INSIGHT BENGALI</p>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">Security Status</label>
                    <p class="text-green-600 font-bold mt-1 flex items-center"><i class="fas fa-check-circle mr-2"></i> Device Bound</p>
                    <p class="text-xs text-gray-400 mt-1">Your account is secure on this phone.</p>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">App Version</label>
                    <p class="text-gray-600 text-sm mt-1">v2.0 (Adaptive Engine)</p>
                </div>
            </div>
            <button onclick="navigate('dashboard')" class="w-full mt-6 py-3 bg-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-300 transition">Back</button>
        </div>

        <!-- VIEW: ADMIN DASHBOARD -->
        <div id="view-admin-dashboard" class="hidden h-full flex flex-col bg-gray-50">
            <div class="bg-gray-900 text-white p-6 pb-12 rounded-b-3xl shrink-0">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Admin Panel</h2>
                    <button onclick="logout()" class="text-gray-400 hover:text-white"><i class="fas fa-sign-out-alt"></i></button>
                </div>
                
                <!-- Stats Cards (Restored) -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                        <h3 class="text-gray-400 text-[10px] uppercase font-bold tracking-wider">Total Students</h3>
                        <p class="text-2xl font-bold text-blue-400 mt-1" id="stat-total-users">--</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                        <h3 class="text-gray-400 text-[10px] uppercase font-bold tracking-wider">Active Devices</h3>
                        <p class="text-2xl font-bold text-green-400 mt-1" id="stat-active-devices">--</p>
                    </div>
                     <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 col-span-2 flex justify-between items-center">
                        <div>
                             <h3 class="text-gray-400 text-[10px] uppercase font-bold tracking-wider">Expired Accounts</h3>
                             <p class="text-xl font-bold text-red-400 mt-1" id="stat-expired-users">--</p>
                        </div>
                        <div class="text-gray-600 text-2xl"><i class="fas fa-user-clock"></i></div>
                    </div>
                </div>
            </div>

            <div class="p-6 -mt-8 grid gap-4">
                <button onclick="navigate('admin-users')" class="bg-white p-5 rounded-xl shadow-lg hover:shadow-xl transition flex items-center justify-between group">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-xl mr-4 group-hover:scale-110 transition">
                            <i class="fas fa-users-cog"></i>
                        </div>
                        <div class="text-left">
                            <h3 class="font-bold text-gray-800">Manage Users</h3>
                            <p class="text-xs text-gray-500">Create IDs, Reset Devices</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </button>

                <div class="bg-white p-5 rounded-xl shadow border border-gray-100">
                    <div class="flex items-center mb-2">
                         <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 mr-3">
                            <i class="fas fa-database"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800">Question Library</h3>
                            <p class="text-xs text-gray-500">Managed via 'questions.js'</p>
                        </div>
                    </div>
                    <div class="text-xs text-gray-400 bg-gray-50 p-2 rounded">
                        <i class="fas fa-info-circle mr-1"></i> Admin cannot add questions manually here. Update the file on the server directly.
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: ADMIN USERS -->
        <div id="view-admin-users" class="hidden h-full flex flex-col bg-white">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 shrink-0">
                <button onclick="navigate('admin-dashboard')" class="text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200"><i class="fas fa-arrow-left"></i></button>
                <h2 class="font-bold text-gray-800">User Management</h2>
                <div class="w-8"></div>
            </div>
            
            <!-- Create User Form -->
            <div class="p-5 bg-blue-50 border-b shrink-0">
                <h3 class="text-xs font-bold text-blue-800 uppercase mb-3"><i class="fas fa-user-plus mr-1"></i> Create New Student</h3>
                <form id="create-user-form" class="space-y-3">
                    <input name="name" type="text" placeholder="Full Name" class="w-full p-3 rounded-lg text-sm border border-blue-200 focus:outline-none focus:border-blue-500" required>
                    <div class="flex space-x-3">
                        <div class="w-2/3">
                            <input name="phone" type="tel" placeholder="Mobile Number" class="w-full p-3 rounded-lg text-sm border border-blue-200 focus:outline-none focus:border-blue-500" required>
                        </div>
                        <div class="w-1/3">
                            <input name="validity" type="number" value="30" placeholder="Days" class="w-full p-3 rounded-lg text-sm border border-blue-200 focus:outline-none focus:border-blue-500" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg text-sm font-bold shadow hover:bg-blue-700 transition">
                        Generate ID & Password
                    </button>
                </form>
            </div>
            
            <!-- List -->
            <div class="flex-grow overflow-y-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-100 text-xs text-gray-500 uppercase sticky top-0">
                        <tr>
                            <th class="p-3 pl-4">Name/ID</th>
                            <th class="p-3">Pass</th>
                            <th class="p-3">Status</th>
                            <th class="p-3 text-right pr-4">Action</th>
                        </tr>
                    </thead>
                    <tbody id="user-list-body" class="divide-y divide-gray-100">
                        <!-- JS Injection -->
                    </tbody>
                </table>
            </div>
        </div>

    </main>
</body>
</html>
